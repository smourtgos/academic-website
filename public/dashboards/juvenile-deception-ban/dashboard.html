<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Did Banning Deceptive Interrogation Tactics Affect Juvenile Case Outcomes?</title>
<meta property="og:title" content="Did Banning Deceptive Interrogation Tactics Affect Juvenile Case Outcomes?" />
<meta name="description" content="Interactive dashboard presenting difference-in-differences analysis of state-level bans on deceptive interrogation tactics for juveniles using NIBRS 2021-2024 data." />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --navy: #1e293b;
  --navy-light: #334155;
  --navy-dark: #0f172a;
  --blue: #3b82f6;
  --blue-light: #60a5fa;
  --blue-dark: #2563eb;
  --white: #ffffff;
  --gray-50: #f8fafc;
  --gray-100: #f1f5f9;
  --gray-200: #e2e8f0;
  --gray-300: #cbd5e1;
  --gray-400: #94a3b8;
  --gray-500: #64748b;
  --gray-600: #475569;
  --gray-700: #334155;
  --red: #ef4444;
  --red-light: #fca5a5;
  --green: #22c55e;
  --amber: #f59e0b;
  --amber-light: #fef3c7;
  --amber-dark: #92400e;
  --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

html { scroll-behavior: smooth; }

body {
  font-family: var(--font);
  background: var(--gray-50);
  color: var(--navy);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
}

/* Navbar */
.navbar {
  background: var(--navy-dark);
  padding: 0 2rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 56px;
  position: sticky;
  top: 0;
  z-index: 1000;
  box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
.navbar-brand {
  color: var(--white);
  font-weight: 600;
  font-size: 0.95rem;
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.navbar-brand:hover { color: var(--blue-light); }
.navbar-back {
  color: var(--gray-400);
  text-decoration: none;
  font-size: 0.85rem;
  font-weight: 500;
  transition: color 0.2s;
}
.navbar-back:hover { color: var(--white); }

/* Header */
.header {
  background: linear-gradient(135deg, var(--navy-dark) 0%, var(--navy) 100%);
  padding: 2.5rem 2rem 2rem;
  color: var(--white);
}
.header-inner {
  max-width: 1200px;
  margin: 0 auto;
}
.category-badge {
  display: inline-block;
  background: var(--blue);
  color: var(--white);
  font-size: 0.7rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  padding: 0.3rem 0.8rem;
  border-radius: 4px;
  text-transform: uppercase;
  margin-bottom: 1rem;
}
.header h1 {
  font-size: clamp(1.5rem, 3vw, 2.2rem);
  font-weight: 800;
  line-height: 1.2;
  margin-bottom: 0.75rem;
  max-width: 800px;
}
.header .subtitle {
  font-size: 0.95rem;
  color: var(--gray-300);
  font-weight: 400;
  max-width: 700px;
}

/* Preliminary banner */
.prelim-banner {
  background: linear-gradient(90deg, #dc2626, #b91c1c);
  color: var(--white);
  text-align: center;
  padding: 0.75rem 1rem;
  font-size: 0.85rem;
  font-weight: 600;
  letter-spacing: 0.02em;
}
.prelim-banner span {
  display: inline-block;
  margin-right: 0.5rem;
  font-size: 1rem;
}

/* Tab navigation */
.tab-nav {
  background: var(--white);
  border-bottom: 1px solid var(--gray-200);
  position: sticky;
  top: 56px;
  z-index: 999;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.tab-nav::-webkit-scrollbar { height: 0; }
.tab-nav-inner {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  padding: 0 1rem;
  gap: 0;
}
.tab-btn {
  background: none;
  border: none;
  padding: 1rem 1.25rem;
  font-family: var(--font);
  font-size: 0.85rem;
  font-weight: 500;
  color: var(--gray-500);
  cursor: pointer;
  white-space: nowrap;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}
.tab-btn:hover {
  color: var(--navy);
  background: var(--gray-50);
}
.tab-btn.active {
  color: var(--blue);
  border-bottom-color: var(--blue);
  font-weight: 600;
}

/* Main content */
.main {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem 1.5rem 4rem;
}
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* KPI cards */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}
.kpi-card {
  background: var(--navy);
  color: var(--white);
  padding: 1.5rem;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
}
.kpi-card .kpi-value {
  font-size: 2rem;
  font-weight: 800;
  line-height: 1.1;
  margin-bottom: 0.25rem;
}
.kpi-card .kpi-label {
  font-size: 0.8rem;
  color: var(--gray-300);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

/* Dark explanatory boxes */
.explain-box {
  background: var(--navy);
  color: var(--gray-200);
  padding: 1.5rem 2rem;
  border-radius: 12px;
  margin-bottom: 2rem;
  font-size: 0.92rem;
  line-height: 1.7;
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
}
.explain-box p { margin-bottom: 0.75rem; }
.explain-box p:last-child { margin-bottom: 0; }
.explain-box strong { color: var(--white); font-weight: 600; }

/* Warning box */
.warning-box {
  background: var(--amber-light);
  border-left: 4px solid var(--amber);
  color: var(--amber-dark);
  padding: 1rem 1.5rem;
  border-radius: 0 8px 8px 0;
  margin: 1.5rem 0;
  font-size: 0.88rem;
  line-height: 1.6;
}

/* Section headings */
.section-title {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--navy);
  margin: 2rem 0 1rem;
}
.section-subtitle {
  font-size: 1rem;
  font-weight: 600;
  color: var(--navy-light);
  margin: 1.5rem 0 0.75rem;
}

/* Chart containers */
.chart-container {
  background: var(--white);
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  border: 1px solid var(--gray-200);
}
.chart-container .chart-title {
  font-size: 1rem;
  font-weight: 600;
  color: var(--navy);
  margin-bottom: 0.5rem;
}
.chart-container .chart-subtitle {
  font-size: 0.82rem;
  color: var(--gray-500);
  margin-bottom: 1rem;
}

/* Tables */
.styled-table-wrapper {
  overflow-x: auto;
  margin-bottom: 2rem;
  border-radius: 12px;
  border: 1px solid var(--gray-200);
  background: var(--white);
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}
.styled-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.88rem;
}
.styled-table thead {
  background: var(--navy);
  color: var(--white);
}
.styled-table thead th {
  padding: 0.85rem 1rem;
  text-align: left;
  font-weight: 600;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  white-space: nowrap;
}
.styled-table tbody tr {
  border-bottom: 1px solid var(--gray-100);
  transition: background 0.15s;
}
.styled-table tbody tr:hover { background: var(--gray-50); }
.styled-table tbody td {
  padding: 0.75rem 1rem;
  white-space: nowrap;
}
.styled-table .positive { color: #16a34a; font-weight: 600; }
.styled-table .negative { color: #dc2626; font-weight: 600; }
.styled-table .neutral { color: var(--gray-500); font-weight: 500; }
.styled-table .sig { font-weight: 700; }

.table-footnote {
  font-size: 0.78rem;
  color: var(--gray-500);
  padding: 0.75rem 1rem;
  background: var(--gray-50);
  border-top: 1px solid var(--gray-100);
  line-height: 1.5;
}

/* Key takeaway box */
.takeaway-box {
  background: var(--navy);
  color: var(--gray-200);
  padding: 1.25rem 1.5rem;
  border-radius: 12px;
  margin: 1.5rem 0;
  border-left: 4px solid var(--blue);
  font-size: 0.92rem;
  line-height: 1.7;
}
.takeaway-box strong { color: var(--white); }

/* Robustness result inline */
.ri-result {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.75rem 0;
  border-bottom: 1px solid var(--gray-100);
}
.ri-result:last-child { border-bottom: none; }
.ri-label {
  font-size: 0.88rem;
  font-weight: 500;
  color: var(--navy);
  min-width: 180px;
}
.ri-value {
  font-size: 0.92rem;
  font-weight: 700;
  color: var(--gray-600);
}

/* Verification check/x */
.check { color: #16a34a; font-weight: 700; }
.cross { color: #dc2626; font-weight: 700; }

/* KPI result cards for sex crimes */
.result-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}
.result-card {
  background: var(--navy);
  color: var(--white);
  padding: 1.75rem;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
}
.result-card .rc-outcome {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--gray-400);
  font-weight: 600;
  margin-bottom: 0.5rem;
}
.result-card .rc-value {
  font-size: 2.2rem;
  font-weight: 800;
  margin-bottom: 0.15rem;
}
.result-card .rc-pval {
  font-size: 0.8rem;
  color: var(--gray-400);
  margin-bottom: 0.5rem;
}
.result-card .rc-tag {
  display: inline-block;
  padding: 0.2rem 0.75rem;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  background: rgba(100,116,139,0.3);
  color: var(--gray-300);
}

/* Outcome toggle */
.outcome-toggle {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
}
.outcome-toggle-label {
  font-size: 0.82rem;
  font-weight: 600;
  color: var(--gray-500);
  text-transform: uppercase;
  letter-spacing: 0.04em;
  align-self: center;
  margin-right: 0.25rem;
}
.outcome-btn {
  padding: 0.45rem 1rem;
  border: 1px solid var(--gray-300);
  background: var(--white);
  border-radius: 6px;
  font-family: var(--font);
  font-size: 0.82rem;
  font-weight: 500;
  color: var(--navy);
  cursor: pointer;
  transition: all 0.2s;
}
.outcome-btn:hover { border-color: var(--blue); color: var(--blue); }
.outcome-btn.active {
  background: var(--blue);
  color: var(--white);
  border-color: var(--blue);
}

/* State selector for time series */
.state-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
}
.state-btn {
  padding: 0.45rem 1rem;
  border: 1px solid var(--gray-300);
  background: var(--white);
  border-radius: 6px;
  font-family: var(--font);
  font-size: 0.82rem;
  font-weight: 500;
  color: var(--navy);
  cursor: pointer;
  transition: all 0.2s;
}
.state-btn:hover { border-color: var(--blue); color: var(--blue); }
.state-btn.active {
  background: var(--blue);
  color: var(--white);
  border-color: var(--blue);
}

/* Footer */
.footer {
  background: var(--navy-dark);
  color: var(--gray-400);
  text-align: center;
  padding: 2rem;
  font-size: 0.82rem;
}
.footer a { color: var(--blue-light); text-decoration: none; }
.footer a:hover { text-decoration: underline; }

/* Responsive — Tablets */
@media (max-width: 768px) {
  .navbar { padding: 0 1rem; }
  .navbar-back { font-size: 0.75rem; }
  .header { padding: 1.5rem 1rem 1.25rem; }
  .header h1 { font-size: 1.3rem; }
  .main { padding: 1.25rem 0.75rem 3rem; }
  .kpi-grid { grid-template-columns: repeat(2, 1fr); }
  .tab-btn { padding: 0.75rem 0.85rem; font-size: 0.78rem; }
  .explain-box { padding: 1.25rem; font-size: 0.85rem; }
  .styled-table { font-size: 0.8rem; }
  .styled-table thead th, .styled-table tbody td { padding: 0.6rem 0.65rem; white-space: normal; }
  .result-cards { grid-template-columns: 1fr; }
  .chart-container { padding: 1rem; }

  /* Outcome toggle — wrap to grid */
  .outcome-toggle { gap: 0.4rem; }
  .outcome-btn { padding: 0.5rem 0.75rem; font-size: 0.78rem; min-height: 44px; }
  .outcome-toggle-label { width: 100%; margin-bottom: 0.15rem; }

  /* State selector — smaller buttons */
  .state-selector { gap: 0.35rem; }
  .state-btn { padding: 0.4rem 0.7rem; font-size: 0.78rem; min-height: 44px; }

  /* RI results stack */
  .ri-result { flex-direction: column; align-items: flex-start; gap: 0.25rem; }
  .ri-label { min-width: auto; }
}

/* Responsive — Phones */
@media (max-width: 480px) {
  .navbar { height: 48px; }
  .navbar-brand { font-size: 0.82rem; }
  .navbar-brand svg { width: 15px; height: 15px; }
  .navbar-back { display: none; }
  .prelim-banner { font-size: 0.75rem; padding: 0.6rem 0.75rem; }
  .header { padding: 1.25rem 0.75rem 1rem; }
  .header h1 { font-size: 1.15rem; }
  .header .subtitle { font-size: 0.82rem; }
  .category-badge { font-size: 0.6rem; padding: 0.25rem 0.6rem; }
  .tab-nav { top: 48px; }
  .tab-btn { padding: 0.6rem 0.65rem; font-size: 0.72rem; }
  .main { padding: 1rem 0.5rem 2rem; }
  .kpi-grid { grid-template-columns: 1fr 1fr; gap: 0.5rem; }
  .kpi-card { padding: 0.85rem; border-radius: 8px; }
  .kpi-card .kpi-value { font-size: 1.5rem; }
  .kpi-card .kpi-label { font-size: 0.7rem; }
  .explain-box { padding: 1rem; font-size: 0.82rem; border-radius: 8px; }
  .chart-container { padding: 0.75rem; border-radius: 8px; }
  .chart-container .chart-title { font-size: 0.88rem; }
  .chart-container .chart-subtitle { font-size: 0.75rem; }
  .section-title { font-size: 1.1rem; }
  .section-subtitle { font-size: 0.88rem; }
  .styled-table { font-size: 0.72rem; }
  .styled-table thead th { font-size: 0.68rem; padding: 0.5rem; }
  .styled-table tbody td { padding: 0.5rem; white-space: normal; }
  .table-footnote { font-size: 0.7rem; padding: 0.6rem 0.75rem; }
  .result-card { padding: 1.25rem; border-radius: 8px; }
  .result-card .rc-value { font-size: 1.8rem; }
  .takeaway-box { padding: 1rem; font-size: 0.85rem; border-radius: 8px; }
  .warning-box { font-size: 0.82rem; padding: 0.85rem 1rem; }
  .footer { padding: 1.5rem 1rem; font-size: 0.75rem; }

  /* Outcome toggle — full width buttons */
  .outcome-toggle { gap: 0.35rem; }
  .outcome-btn { flex: 1 1 auto; text-align: center; padding: 0.5rem 0.5rem; font-size: 0.72rem; min-height: 44px; }

  /* State selector — compact grid */
  .state-selector { gap: 0.3rem; }
  .state-btn { flex: 1 1 calc(25% - 0.3rem); text-align: center; padding: 0.45rem 0.3rem; font-size: 0.72rem; min-height: 44px; }
}
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar">
  <a class="navbar-brand" href="#">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h18v18H3z"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
    Juvenile Interrogation Policy Dashboard
  </a>
  <a class="navbar-back" href="https://smourtgos.netlify.app">&larr; Back to Main Site</a>
</nav>

<!-- Preliminary Results Banner -->
<div class="prelim-banner">
  <span>&#9888;</span> PRELIMINARY RESULTS &mdash; These results are preliminary and should not be cited or distributed.
</div>

<!-- Header -->
<div class="header">
  <div class="header-inner">
    <div class="category-badge">Policy Evaluation</div>
    <h1>Did Banning Deceptive Interrogation Tactics Affect Juvenile Case Outcomes?</h1>
    <p class="subtitle">Difference-in-differences analysis using NIBRS data from 41 states, 2021&ndash;2024</p>
  </div>
</div>

<!-- Tab Navigation -->
<div class="tab-nav">
  <div class="tab-nav-inner">
    <button class="tab-btn active" data-tab="overview">Overview</button>
    <button class="tab-btn" data-tab="state-results">State Results</button>
    <button class="tab-btn" data-tab="time-effects">Effects Over Time</button>
    <button class="tab-btn" data-tab="sex-crimes">Sex Crimes</button>
    <button class="tab-btn" data-tab="verification">How I Verified</button>
    <button class="tab-btn" data-tab="about">About &amp; Methodology</button>
  </div>
</div>

<!-- Main Content -->
<div class="main">

<!-- ============================================================ -->
<!-- TAB 1: OVERVIEW -->
<!-- ============================================================ -->
<div class="tab-panel active" id="panel-overview">

  <!-- KPI Cards -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-value">7</div>
      <div class="kpi-label">Treated States</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value">34</div>
      <div class="kpi-label">Control States</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value">2021&ndash;2024</div>
      <div class="kpi-label">NIBRS Data</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value">~510K</div>
      <div class="kpi-label">Juvenile Incidents</div>
    </div>
  </div>

  <!-- Explanatory box -->
  <div class="explain-box">
    <p>Between 2022 and 2024, seven U.S. states banned the use of deceptive interrogation tactics on juveniles. This dashboard presents results from a difference-in-differences analysis examining whether these bans affected how juvenile cases are resolved &mdash; specifically, whether cases are cleared by arrest, cleared by exceptional means (e.g., prosecution declined, victim refused cooperation), or cleared at all.</p>
    <p><strong>The key finding:</strong> when all seven states are analyzed together, there is no statistically significant effect on any clearance outcome. However, there is substantial variation across individual states.</p>
  </div>

  <!-- Outcome toggle for Overview -->
  <div class="outcome-toggle" id="overview-outcome-toggle">
    <span class="outcome-toggle-label">Outcome:</span>
    <button class="outcome-btn active" data-outcome="clear_rate">Any Clearance</button>
    <button class="outcome-btn" data-outcome="arrest_rate">Arrest Clearance</button>
    <button class="outcome-btn" data-outcome="exc_rate">Exceptional Clearance</button>
  </div>

  <!-- Choropleth map -->
  <div class="chart-container">
    <div class="chart-title" id="map-title">State Effects on Any Clearance Rate</div>
    <div class="chart-subtitle">Estimated change in percentage points after ban enactment. Gray states are controls.</div>
    <div id="map-overview" style="width:100%;"></div>
  </div>

  <!-- State law details table -->
  <h3 class="section-title">State Law Details</h3>
  <div class="styled-table-wrapper">
    <table class="styled-table" id="state-law-table">
      <thead>
        <tr>
          <th>State</th>
          <th>Effective Date</th>
          <th>Law Strength</th>
          <th id="state-law-effect-header">Effect on Any Clearance (pp)</th>
        </tr>
      </thead>
      <tbody id="state-law-tbody">
      </tbody>
    </table>
    <div class="table-footnote">*** p &lt; 0.01; ** p &lt; 0.05; * p &lt; 0.10. &#9888; Nevada has only ~6 months of post-treatment data; results should be interpreted with extreme caution.</div>
  </div>

</div>

<!-- ============================================================ -->
<!-- TAB 2: STATE RESULTS -->
<!-- ============================================================ -->
<div class="tab-panel" id="panel-state-results">

  <div class="explain-box">
    <p><strong>How to read this section:</strong> Each number represents the estimated change in clearance rate (in percentage points) after a state enacted its ban, compared to what would have been expected without the ban. A positive number means more cases were cleared; a negative number means fewer. Statistical significance (marked with asterisks) indicates the result is unlikely due to chance alone.</p>
  </div>

  <!-- Heatmap -->
  <div class="chart-container">
    <div class="chart-title">State-by-Outcome Heatmap</div>
    <div class="chart-subtitle">Average treatment effect on the treated (ATT) in percentage points, with significance markers.</div>
    <div id="heatmap-state" style="width:100%;"></div>
  </div>

  <!-- Outcome toggle for bar chart -->
  <div class="outcome-toggle" id="bar-outcome-toggle">
    <span class="outcome-toggle-label">Outcome:</span>
    <button class="outcome-btn active" data-outcome="arrest_rate">Arrest Clearance</button>
    <button class="outcome-btn" data-outcome="exc_rate">Exceptional Clearance</button>
    <button class="outcome-btn" data-outcome="clear_rate">Any Clearance</button>
  </div>

  <!-- Bar chart -->
  <div class="chart-container">
    <div class="chart-title" id="bar-title">Arrest Clearance Effects by State</div>
    <div class="chart-subtitle" id="bar-subtitle">Estimated change in arrest clearance rate (pp) with 95% confidence intervals.</div>
    <div id="bar-arrest" style="width:100%;"></div>
  </div>

</div>

<!-- ============================================================ -->
<!-- TAB 3: EFFECTS OVER TIME -->
<!-- ============================================================ -->
<div class="tab-panel" id="panel-time-effects">

  <div class="explain-box">
    <p><strong>How to read these plots:</strong> Each chart tracks the estimated effect of a ban over time for a single state. The solid line shows the estimated change in clearance rate (in percentage points) at each time point after the ban took effect. The shaded band represents the 95% confidence interval &mdash; the range where the true effect likely falls. When the band includes zero (the dashed horizontal line), the effect is not statistically distinguishable from no change.</p>
  </div>

  <!-- Outcome toggle for time series -->
  <div class="outcome-toggle" id="time-outcome-toggle">
    <span class="outcome-toggle-label">Outcome:</span>
    <button class="outcome-btn active" data-outcome="arrest_rate">Arrest Clearance</button>
    <button class="outcome-btn" data-outcome="exc_rate">Exceptional Clearance</button>
    <button class="outcome-btn" data-outcome="clear_rate">Any Clearance</button>
  </div>

  <!-- State selector buttons -->
  <div class="state-selector" id="time-state-selector">
    <button class="state-btn active" data-state="IL">Illinois</button>
    <button class="state-btn" data-state="OR">Oregon</button>
    <button class="state-btn" data-state="UT">Utah</button>
    <button class="state-btn" data-state="DE">Delaware</button>
    <button class="state-btn" data-state="IN">Indiana</button>
    <button class="state-btn" data-state="CO">Colorado</button>
    <button class="state-btn" data-state="NV">Nevada</button>
  </div>

  <div class="chart-container">
    <div id="time-chart" style="width:100%;"></div>
  </div>

  <div class="warning-box" id="nv-warning" style="display:none;">
    &#9888; <strong>Nevada</strong> enacted its ban in July 2024 and has only ~6 months of post-treatment data. The initial positive effect reverses sharply by month 4. These results should be interpreted with extreme caution.
  </div>

</div>

<!-- ============================================================ -->
<!-- TAB 4: SEX CRIMES -->
<!-- ============================================================ -->
<div class="tab-panel" id="panel-sex-crimes">

  <div class="explain-box">
    <p><strong>Why sex crimes matter:</strong> Confessions play an outsized role in sex crime investigations, particularly those involving juveniles. Because deceptive interrogation tactics are often used to elicit confessions, these bans might be expected to have an especially visible impact on sex crime clearance rates. The results tell a different story.</p>
  </div>

  <h3 class="section-title">Pooled Results (All 7 States)</h3>
  <div class="result-cards">
    <div class="result-card">
      <div class="rc-outcome">Arrest Clearance</div>
      <div class="rc-value">+0.02 <span style="font-size:0.9rem;">pp</span></div>
      <div class="rc-pval">p = 0.979</div>
      <div class="rc-tag">No effect</div>
    </div>
    <div class="result-card">
      <div class="rc-outcome">Exceptional Clearance</div>
      <div class="rc-value">-0.56 <span style="font-size:0.9rem;">pp</span></div>
      <div class="rc-pval">p = 0.511</div>
      <div class="rc-tag">No effect</div>
    </div>
    <div class="result-card">
      <div class="rc-outcome">Any Clearance</div>
      <div class="rc-value">-0.53 <span style="font-size:0.9rem;">pp</span></div>
      <div class="rc-pval">p = 0.693</div>
      <div class="rc-tag">No effect</div>
    </div>
  </div>

  <div class="takeaway-box">
    <strong>Key takeaway:</strong> Across all seven treated states, the bans show no measurable impact on juvenile sex crime clearance rates. This null finding is consistent across all three primary outcomes.
  </div>

  <h3 class="section-title">State-Level Sex Crime Results</h3>
  <div class="styled-table-wrapper">
    <table class="styled-table">
      <thead>
        <tr>
          <th>State</th>
          <th>Arrest (pp)</th>
          <th>p-value</th>
          <th>Exc. Clearance (pp)</th>
          <th>p-value</th>
          <th>Any Clearance (pp)</th>
          <th>p-value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Illinois</td>
          <td class="positive sig">+1.94</td>
          <td>&lt;0.001</td>
          <td class="neutral">+0.42</td>
          <td>0.490</td>
          <td class="positive sig">+2.36</td>
          <td>&lt;0.001</td>
        </tr>
        <tr>
          <td>Oregon</td>
          <td class="negative sig">-2.68</td>
          <td>&lt;0.001</td>
          <td class="positive sig">+2.65</td>
          <td>&lt;0.001</td>
          <td class="neutral">-0.03</td>
          <td>0.970</td>
        </tr>
        <tr>
          <td>Utah</td>
          <td class="neutral">+0.93</td>
          <td>0.064</td>
          <td class="neutral">+0.43</td>
          <td>0.326</td>
          <td class="neutral">+1.36</td>
          <td>0.054</td>
        </tr>
        <tr>
          <td>Delaware</td>
          <td class="positive sig">+2.66</td>
          <td>&lt;0.001</td>
          <td class="negative sig">-4.75</td>
          <td>&lt;0.001</td>
          <td class="negative sig">-2.09</td>
          <td>0.004</td>
        </tr>
        <tr>
          <td>Nevada</td>
          <td class="positive">+1.14</td>
          <td>0.022</td>
          <td class="positive sig">+1.11</td>
          <td>&lt;0.001</td>
          <td class="positive sig">+2.25</td>
          <td>&lt;0.001</td>
        </tr>
        <tr>
          <td>Indiana</td>
          <td class="positive sig">+1.30</td>
          <td>&lt;0.001</td>
          <td class="negative">-1.15</td>
          <td>0.036</td>
          <td class="neutral">+0.15</td>
          <td>0.824</td>
        </tr>
        <tr>
          <td>Colorado</td>
          <td class="negative sig">-2.14</td>
          <td>&lt;0.001</td>
          <td class="negative sig">-2.21</td>
          <td>&lt;0.001</td>
          <td class="negative sig">-4.35</td>
          <td>&lt;0.001</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="takeaway-box">
    <strong>Note:</strong> Oregon's sex crime results notably reverse direction from its overall results: arrest clearance decreases by 2.68 pp for sex crimes (compared to a 2.80 pp increase overall), suggesting the ban may have affected sex crime investigations differently than other case types.
  </div>

</div>

<!-- ============================================================ -->
<!-- TAB 5: HOW WE VERIFIED -->
<!-- ============================================================ -->
<div class="tab-panel" id="panel-verification">

  <div class="explain-box">
    <p>Any good study needs to check its own work. Below are three methods I used to test whether the findings are robust.</p>
  </div>

  <!-- Randomization Inference -->
  <h3 class="section-title">Randomization Inference</h3>
  <div class="chart-container">
    <p style="font-size:0.92rem;color:var(--gray-600);margin-bottom:1rem;line-height:1.7;">If these bans had no real effect, how unusual would the results be? To answer this, I randomly reshuffled treatment assignments 500 times and re-estimated the effect each time. This creates a distribution of &ldquo;fake&rdquo; effects that would arise by chance alone.</p>
    <p style="font-size:0.92rem;font-weight:600;color:var(--navy);margin-bottom:1.25rem;">Result: The pooled estimates are well within the range of random noise.</p>
    <div style="padding:0 0.5rem;">
      <div class="ri-result">
        <span class="ri-label">Arrest clearance</span>
        <span class="ri-value">empirical p = 0.558</span>
      </div>
      <div class="ri-result">
        <span class="ri-label">Exceptional clearance</span>
        <span class="ri-value">empirical p = 0.294</span>
      </div>
      <div class="ri-result">
        <span class="ri-label">Any clearance</span>
        <span class="ri-value">empirical p = 0.926</span>
      </div>
    </div>
    <p style="font-size:0.88rem;color:var(--gray-500);margin-top:1.25rem;line-height:1.6;"><strong style="color:var(--navy);">In plain English:</strong> If you shuffled which states got bans, you would get results as large as these more than half the time. This confirms there is no robust pooled effect.</p>
  </div>

  <!-- Bayesian Analysis -->
  <h3 class="section-title">Bayesian Analysis</h3>
  <div class="chart-container">
    <p style="font-size:0.92rem;color:var(--gray-600);margin-bottom:1.25rem;line-height:1.7;">A complementary statistical approach that asks: given the data, what is the probability the ban had a positive vs. negative effect?</p>
    <div class="styled-table-wrapper" style="margin-bottom:1rem;">
      <table class="styled-table">
        <thead>
          <tr>
            <th>Outcome</th>
            <th>Estimate (logit)</th>
            <th>95% Credible Interval</th>
            <th>Excludes Zero?</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Arrest clearance</td>
            <td>0.121</td>
            <td>[0.026, 0.224]</td>
            <td><span class="check">&#10003; Yes</span></td>
          </tr>
          <tr>
            <td>Any clearance</td>
            <td>0.097</td>
            <td>[-0.015, 0.231]</td>
            <td><span class="cross">&#10007; No</span></td>
          </tr>
          <tr>
            <td>Exceptional clearance</td>
            <td>-0.067</td>
            <td>[-0.296, 0.149]</td>
            <td><span class="cross">&#10007; No</span></td>
          </tr>
        </tbody>
      </table>
    </div>
    <p style="font-size:0.88rem;color:var(--gray-500);line-height:1.6;">Only arrest clearance shows a credible positive effect under the Bayesian framework. For all other outcomes, the uncertainty is too large to draw conclusions.</p>
  </div>

</div>

<!-- ============================================================ -->
<!-- TAB 6: ABOUT & METHODOLOGY -->
<!-- ============================================================ -->
<div class="tab-panel" id="panel-about">

  <div class="explain-box">
    <p>This dashboard presents results from a quasi-experimental analysis of state-level bans on deceptive interrogation tactics for juveniles.</p>
  </div>

  <div class="takeaway-box" style="margin-bottom:2rem;">
    <p><strong>What is difference-in-differences?</strong></p>
    <p style="margin-top:0.5rem;">This study uses a difference-in-differences (DiD) design &mdash; a statistical method that compares changes in outcomes over time between states that enacted bans (treated states) and states that did not (control states). The key idea: if treated and control states were trending similarly before the ban, any divergence afterward can be attributed to the policy change.</p>
    <p style="margin-top:0.5rem;">The analysis uses two-way fixed effects with two-way clustering (by state and time) to account for both geographic and temporal correlation.</p>
  </div>

  <h3 class="section-title">Treatment Definitions</h3>
  <div class="styled-table-wrapper">
    <table class="styled-table">
      <thead>
        <tr>
          <th>State</th>
          <th>Effective Date</th>
          <th>Burden Strength</th>
          <th>Definition Breadth</th>
          <th>Good-Faith Exception</th>
          <th>Public Safety Exception</th>
          <th>Extra Mandates</th>
          <th>Overall Strength</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Illinois</td>
          <td>Jan 1, 2022</td>
          <td>Moderate</td>
          <td>Broad</td>
          <td>No</td>
          <td>No</td>
          <td>No</td>
          <td>Moderate</td>
        </tr>
        <tr>
          <td>Oregon</td>
          <td>Jan 1, 2022</td>
          <td>Strong</td>
          <td>Broad</td>
          <td>No</td>
          <td>No</td>
          <td>No</td>
          <td>Strong</td>
        </tr>
        <tr>
          <td>Utah</td>
          <td>May 4, 2022</td>
          <td>Moderate</td>
          <td>Narrow</td>
          <td>No</td>
          <td>No</td>
          <td>No</td>
          <td>Weak</td>
        </tr>
        <tr>
          <td>Delaware</td>
          <td>Oct 10, 2022</td>
          <td>Moderate</td>
          <td>Narrow</td>
          <td>No</td>
          <td>No</td>
          <td>No</td>
          <td>Weak-Moderate</td>
        </tr>
        <tr>
          <td>Indiana</td>
          <td>Jul 1, 2023</td>
          <td>Moderate</td>
          <td>Broad</td>
          <td>Yes</td>
          <td>No</td>
          <td>No</td>
          <td>Weak-Moderate</td>
        </tr>
        <tr>
          <td>Colorado</td>
          <td>Aug 7, 2023</td>
          <td>Moderate</td>
          <td>Very Broad</td>
          <td>Yes</td>
          <td>No</td>
          <td>Yes</td>
          <td>Moderate-Strong</td>
        </tr>
        <tr>
          <td>Nevada</td>
          <td>Jul 1, 2024</td>
          <td>Moderate</td>
          <td>Narrow</td>
          <td>No</td>
          <td>Yes</td>
          <td>No</td>
          <td>Weak</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="chart-container" style="margin-top:2rem;">
    <p style="font-size:0.92rem;color:var(--gray-600);margin-bottom:0.5rem;"><strong style="color:var(--navy);">Data source:</strong> FBI National Incident-Based Reporting System (NIBRS), 2021&ndash;2024.</p>
    <p style="font-size:0.92rem;color:var(--gray-600);margin-bottom:0.5rem;"><strong style="color:var(--navy);">Author:</strong> Scott M. Mourtgos, Ph.D. &mdash; University of South Carolina</p>
    <p style="font-size:0.92rem;margin-top:1rem;"><a href="https://smourtgos.netlify.app" style="color:var(--blue);text-decoration:none;font-weight:500;">&larr; Back to smourtgos.netlify.app</a></p>
  </div>

</div>

</div><!-- end .main -->

<!-- Footer -->
<div class="footer">
  <p>Scott M. Mourtgos, Ph.D. &mdash; University of South Carolina</p>
  <p style="margin-top:0.4rem;"><a href="https://smourtgos.netlify.app">&larr; Back to Main Site</a></p>
</div>

<!-- ============================================================ -->
<!-- JAVASCRIPT -->
<!-- ============================================================ -->
<script>
(function() {
  'use strict';

  // ---- Tab switching ----
  var tabBtns = document.querySelectorAll('.tab-btn');
  var panels = document.querySelectorAll('.tab-panel');

  tabBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      var tabId = this.getAttribute('data-tab');
      tabBtns.forEach(function(b) { b.classList.remove('active'); });
      this.classList.add('active');
      panels.forEach(function(p) { p.classList.remove('active'); });
      document.getElementById('panel-' + tabId).classList.add('active');
      window.dispatchEvent(new Event('resize'));
    });
  });

  // ---- Responsive helpers ----
  function isMobile() { return window.innerWidth <= 768; }
  function isPhone() { return window.innerWidth <= 480; }

  function chartHeight(desktopH, tabletH, phoneH) {
    if (isPhone()) return phoneH;
    if (isMobile()) return tabletH;
    return desktopH;
  }

  // ---- Plotly defaults ----
  function getPlotlyConfig() {
    return {
      responsive: true,
      displayModeBar: !isMobile(),
      modeBarButtonsToRemove: ['select2d','lasso2d','autoScale2d'],
      displaylogo: false,
      scrollZoom: false,
      toImageButtonOptions: { format: 'png', scale: 2 }
    };
  }

  var fontFamily = "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";

  // ---- Outcome labels ----
  var outcomeLabels = {
    'arrest_rate': 'Arrest Clearance',
    'exc_rate': 'Exceptional Clearance',
    'clear_rate': 'Any Clearance'
  };

  // ---- State names ----
  var stateNames = {
    'AL':'Alabama','AK':'Alaska','AZ':'Arizona','AR':'Arkansas','CA':'California',
    'CO':'Colorado','CT':'Connecticut','DE':'Delaware','FL':'Florida','GA':'Georgia',
    'HI':'Hawaii','ID':'Idaho','IL':'Illinois','IN':'Indiana','IA':'Iowa','KS':'Kansas',
    'KY':'Kentucky','LA':'Louisiana','ME':'Maine','MD':'Maryland','MA':'Massachusetts',
    'MI':'Michigan','MN':'Minnesota','MS':'Mississippi','MO':'Missouri','MT':'Montana',
    'NE':'Nebraska','NV':'Nevada','NH':'New Hampshire','NJ':'New Jersey','NM':'New Mexico',
    'NY':'New York','NC':'North Carolina','ND':'North Dakota','OH':'Ohio','OK':'Oklahoma',
    'OR':'Oregon','PA':'Pennsylvania','RI':'Rhode Island','SC':'South Carolina',
    'SD':'South Dakota','TN':'Tennessee','TX':'Texas','UT':'Utah','VT':'Vermont',
    'VA':'Virginia','WA':'Washington','WI':'Wisconsin','WY':'Wyoming'
  };

  var controlStates = ['AL','AK','AZ','AR','CA','CT','FL','GA','HI','ID','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NH','NJ','NM','NY','NC','ND','OH','OK','PA','RI','SC','SD','TN','TX','VA','VT','WA','WI','WY'];

  // ---- All state-level results by outcome ----
  var stateResults = {
    'arrest_rate': {
      'IL': { att: 1.31, p: 0.118, ciLo: -0.33, ciHi: 2.96 },
      'OR': { att: 2.80, p: 0.0006, ciLo: 1.20, ciHi: 4.41 },
      'UT': { att: 0.07, p: 0.928, ciLo: -1.44, ciHi: 1.58 },
      'DE': { att: 3.09, p: 0.0002, ciLo: 1.48, ciHi: 4.70 },
      'NV': { att: 1.91, p: 0.003, ciLo: 0.63, ciHi: 3.18 },
      'IN': { att: 1.64, p: 0.022, ciLo: 0.24, ciHi: 3.03 },
      'CO': { att: 0.07, p: 0.924, ciLo: -1.29, ciHi: 1.42 }
    },
    'exc_rate': {
      'IL': { att: -0.08, p: 0.810, ciLo: -0.76, ciHi: 0.59 },
      'OR': { att: 1.63, p: 7.09e-7, ciLo: 0.99, ciHi: 2.28 },
      'UT': { att: 0.23, p: 0.484, ciLo: -0.41, ciHi: 0.86 },
      'DE': { att: -3.32, p: 1.60e-20, ciLo: -4.02, ciHi: -2.62 },
      'NV': { att: 0.55, p: 0.012, ciLo: 0.12, ciHi: 0.98 },
      'IN': { att: -1.15, p: 8.88e-5, ciLo: -1.72, ciHi: -0.57 },
      'CO': { att: -2.13, p: 4.33e-12, ciLo: -2.73, ciHi: -1.52 }
    },
    'clear_rate': {
      'IL': { att: 1.23, p: 0.189, ciLo: -0.61, ciHi: 3.07 },
      'OR': { att: 4.43, p: 8.73e-7, ciLo: 2.67, ciHi: 6.20 },
      'UT': { att: 0.30, p: 0.725, ciLo: -1.35, ciHi: 1.94 },
      'DE': { att: -0.23, p: 0.778, ciLo: -1.81, ciHi: 1.36 },
      'NV': { att: 2.46, p: 0.0001, ciLo: 1.19, ciHi: 3.73 },
      'IN': { att: 0.49, p: 0.499, ciLo: -0.93, ciHi: 1.91 },
      'CO': { att: -2.06, p: 0.003, ciLo: -3.44, ciHi: -0.68 }
    }
  };

  // ---- State law details ----
  var stateLawDetails = [
    { name: 'Illinois', abbr: 'IL', date: 'Jan 1, 2022', strength: 'Moderate' },
    { name: 'Oregon', abbr: 'OR', date: 'Jan 1, 2022', strength: 'Strong' },
    { name: 'Utah', abbr: 'UT', date: 'May 4, 2022', strength: 'Weak' },
    { name: 'Delaware', abbr: 'DE', date: 'Oct 10, 2022', strength: 'Weak-Moderate' },
    { name: 'Indiana', abbr: 'IN', date: 'Jul 1, 2023', strength: 'Weak-Moderate' },
    { name: 'Colorado', abbr: 'CO', date: 'Aug 7, 2023', strength: 'Moderate-Strong' },
    { name: 'Nevada', abbr: 'NV', date: 'Jul 1, 2024', strength: 'Weak' }
  ];

  function sigMarker(p) {
    if (p < 0.001) return '***';
    if (p < 0.01) return '**';
    if (p < 0.05) return '*';
    return '';
  }

  function effectClass(att, p) {
    if (p < 0.05) return att >= 0 ? 'positive sig' : 'negative sig';
    if (att > 0.5) return 'positive';
    if (att < -0.5) return 'negative';
    return 'neutral';
  }

  // ---- Current overview outcome ----
  var currentOverviewOutcome = 'clear_rate';

  // ---- TAB 1: Choropleth Map ----
  function renderMap(outcome) {
    var treatedMap = {};
    var states = ['IL','OR','UT','DE','NV','IN','CO'];
    states.forEach(function(s) {
      treatedMap[s] = stateResults[outcome][s].att;
    });

    var allStates = controlStates.concat(Object.keys(treatedMap));
    allStates = allStates.filter(function(v, i, a) { return a.indexOf(v) === i; });

    var locations = [];
    var zValues = [];
    var textLabels = [];

    allStates.forEach(function(s) {
      locations.push(s);
      var name = stateNames[s] || s;
      if (treatedMap.hasOwnProperty(s)) {
        zValues.push(treatedMap[s]);
        var sign = treatedMap[s] >= 0 ? '+' : '';
        textLabels.push('<b>' + name + '</b><br>Effect: ' + sign + treatedMap[s].toFixed(2) + ' pp<br><i>Treated state</i>');
      } else {
        zValues.push(null);
        textLabels.push('<b>' + name + '</b><br><i>Control state</i>');
      }
    });

    var data = [{
      type: 'choropleth',
      locationmode: 'USA-states',
      locations: locations,
      z: zValues,
      text: textLabels,
      hoverinfo: 'text',
      colorscale: [
        [0, '#dc2626'],
        [0.35, '#fca5a5'],
        [0.5, '#f8fafc'],
        [0.65, '#93c5fd'],
        [1, '#1d4ed8']
      ],
      zmin: -5,
      zmax: 5,
      colorbar: {
        title: { text: 'Effect (pp)', font: { size: 12, family: fontFamily } },
        thickness: 15,
        len: 0.6,
        tickfont: { size: 11, family: fontFamily }
      },
      marker: {
        line: { color: '#94a3b8', width: 0.5 }
      }
    }];

    var mapH = chartHeight(500, 380, 300);
    document.getElementById('map-overview').style.height = mapH + 'px';

    var layout = {
      geo: {
        scope: 'usa',
        bgcolor: 'rgba(0,0,0,0)',
        lakecolor: '#e2e8f0',
        landcolor: '#e2e8f0',
        showlakes: true,
        showframe: false,
        projection: { type: 'albers usa' }
      },
      height: mapH,
      margin: isMobile() ? { t: 5, b: 5, l: 5, r: 5 } : { t: 10, b: 10, l: 10, r: 10 },
      paper_bgcolor: 'rgba(0,0,0,0)',
      font: { family: fontFamily, size: isMobile() ? 10 : 12 }
    };

    Plotly.newPlot('map-overview', data, layout, getPlotlyConfig());
    document.getElementById('map-title').textContent = 'State Effects on ' + outcomeLabels[outcome] + ' Rate';
  }

  // ---- TAB 1: State Law Table ----
  function renderLawTable(outcome) {
    var tbody = document.getElementById('state-law-tbody');
    tbody.innerHTML = '';
    document.getElementById('state-law-effect-header').textContent = 'Effect on ' + outcomeLabels[outcome] + ' (pp)';

    stateLawDetails.forEach(function(s) {
      var r = stateResults[outcome][s.abbr];
      var sign = r.att >= 0 ? '+' : '';
      var sig = sigMarker(r.p);
      var cls = effectClass(r.att, r.p);
      var nvWarning = s.abbr === 'NV' ? ' \u26A0' : '';
      var tr = document.createElement('tr');
      tr.innerHTML = '<td>' + s.name + '</td>' +
        '<td>' + s.date + '</td>' +
        '<td>' + s.strength + '</td>' +
        '<td class="' + cls + '">' + sign + r.att.toFixed(2) + sig + nvWarning + '</td>';
      tbody.appendChild(tr);
    });
  }

  // ---- Overview outcome toggle handler ----
  document.querySelectorAll('#overview-outcome-toggle .outcome-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('#overview-outcome-toggle .outcome-btn').forEach(function(b) { b.classList.remove('active'); });
      this.classList.add('active');
      currentOverviewOutcome = this.getAttribute('data-outcome');
      renderMap(currentOverviewOutcome);
      renderLawTable(currentOverviewOutcome);
    });
  });

  // ---- TAB 2: Heatmap ----
  function renderHeatmap() {
    var states = ['CO','DE','IL','IN','NV','OR','UT'];
    var outcomes = ['Arrest Clearance','Exceptional Clearance','Any Clearance'];
    var outcomeKeys = ['arrest_rate','exc_rate','clear_rate'];

    var att = [];
    var pvals = [];
    states.forEach(function(s) {
      var row = [];
      var prow = [];
      outcomeKeys.forEach(function(o) {
        row.push(stateResults[o][s].att);
        prow.push(stateResults[o][s].p);
      });
      att.push(row);
      pvals.push(prow);
    });

    var annotations = [];
    var hoverText = [];
    for (var i = 0; i < states.length; i++) {
      var row = [];
      for (var j = 0; j < outcomes.length; j++) {
        var sign = att[i][j] >= 0 ? '+' : '';
        var sig = sigMarker(pvals[i][j]);
        var label = sign + att[i][j].toFixed(2) + sig;
        annotations.push({
          x: outcomes[j],
          y: states[i],
          text: label,
          showarrow: false,
          font: {
            size: 13,
            color: Math.abs(att[i][j]) > 2.5 ? '#ffffff' : '#1e293b',
            family: fontFamily,
            weight: 600
          }
        });
        row.push('<b>' + states[i] + ' \u2014 ' + outcomes[j] + '</b><br>ATT: ' + sign + att[i][j].toFixed(2) + ' pp<br>p = ' + pvals[i][j].toExponential(2));
      }
      hoverText.push(row);
    }

    var heatH = chartHeight(420, 360, 320);
    document.getElementById('heatmap-state').style.height = heatH + 'px';

    var data = [{
      type: 'heatmap',
      z: att,
      x: outcomes,
      y: states,
      text: hoverText,
      hoverinfo: 'text',
      colorscale: [
        [0, '#dc2626'],
        [0.35, '#fca5a5'],
        [0.5, '#f1f5f9'],
        [0.65, '#93c5fd'],
        [1, '#1d4ed8']
      ],
      zmid: 0,
      zmin: -5,
      zmax: 5,
      colorbar: {
        title: { text: 'ATT (pp)', font: { size: isMobile() ? 9 : 11, family: fontFamily } },
        thickness: isMobile() ? 10 : 15,
        tickfont: { size: isMobile() ? 8 : 10, family: fontFamily }
      },
      xgap: 3,
      ygap: 3
    }];

    // Adjust annotation font size for mobile
    annotations.forEach(function(a) {
      a.font.size = isMobile() ? 10 : 13;
    });

    var layout = {
      height: heatH,
      annotations: annotations,
      margin: isMobile() ? { t: 20, b: 60, l: 40, r: 50 } : { t: 30, b: 80, l: 50, r: 80 },
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)',
      font: { family: fontFamily },
      xaxis: { side: 'bottom', tickfont: { size: isMobile() ? 9 : 12 } },
      yaxis: { tickfont: { size: isMobile() ? 10 : 12 }, autorange: 'reversed' }
    };

    Plotly.newPlot('heatmap-state', data, layout, getPlotlyConfig());
  }

  // ---- TAB 2: Bar chart ----
  var currentBarOutcome = 'arrest_rate';

  function renderBarChart(outcome) {
    currentBarOutcome = outcome;
    var label = outcomeLabels[outcome];

    // Sort states by ATT value for display
    var stateOrder = ['IL','OR','UT','DE','NV','IN','CO'];
    var sorted = stateOrder.map(function(s) {
      return { abbr: s, data: stateResults[outcome][s] };
    }).sort(function(a, b) { return a.data.att - b.data.att; });

    var states = sorted.map(function(d) { return d.abbr; });
    var values = sorted.map(function(d) { return d.data.att; });
    var ciLo = sorted.map(function(d) { return d.data.ciLo; });
    var ciHi = sorted.map(function(d) { return d.data.ciHi; });

    var barColors = values.map(function(v) {
      return v >= 0 ? '#3b82f6' : '#ef4444';
    });

    var errorYLow = values.map(function(v, i) { return v - ciLo[i]; });
    var errorYHigh = values.map(function(v, i) { return ciHi[i] - v; });

    var barH = chartHeight(400, 340, 300);
    document.getElementById('bar-arrest').style.height = barH + 'px';

    var data = [{
      type: 'bar',
      x: states,
      y: values,
      marker: { color: barColors, cornerradius: 4 },
      error_y: {
        type: 'data',
        symmetric: false,
        array: errorYHigh,
        arrayminus: errorYLow,
        color: '#475569',
        thickness: 1.5,
        width: isMobile() ? 4 : 6
      },
      hovertemplate: '<b>%{x}</b><br>ATT: %{y:.2f} pp<br>95% CI: [%{customdata[0]:.2f}, %{customdata[1]:.2f}]<extra></extra>',
      customdata: states.map(function(s, i) { return [ciLo[i], ciHi[i]]; })
    }];

    var layout = {
      height: barH,
      margin: isMobile() ? { t: 15, b: 40, l: 45, r: 10 } : { t: 20, b: 50, l: 60, r: 20 },
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)',
      font: { family: fontFamily },
      xaxis: {
        tickfont: { size: isMobile() ? 10 : 13, color: '#1e293b' }
      },
      yaxis: {
        title: { text: 'Change in ' + label + ' Rate (pp)', font: { size: isMobile() ? 10 : 12 } },
        tickfont: { size: isMobile() ? 9 : 11 },
        zeroline: true,
        zerolinecolor: '#94a3b8',
        zerolinewidth: 1.5,
        gridcolor: '#e2e8f0'
      },
      shapes: [{
        type: 'line',
        x0: -0.5, x1: 6.5,
        y0: 0, y1: 0,
        line: { color: '#475569', width: 1, dash: 'dash' }
      }]
    };

    Plotly.newPlot('bar-arrest', data, layout, getPlotlyConfig());
    document.getElementById('bar-title').textContent = label + ' Effects by State';
    document.getElementById('bar-subtitle').textContent = 'Estimated change in ' + label.toLowerCase() + ' rate (pp) with 95% confidence intervals.';
  }

  // ---- Bar chart outcome toggle handler ----
  document.querySelectorAll('#bar-outcome-toggle .outcome-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('#bar-outcome-toggle .outcome-btn').forEach(function(b) { b.classList.remove('active'); });
      this.classList.add('active');
      renderBarChart(this.getAttribute('data-outcome'));
    });
  });

  // ---- TAB 3: Time series data (all three outcomes) ----
  var timeData = {
    'arrest_rate': {
      'IL': {
        label: 'Illinois', effectiveDate: 'Jan 1, 2022',
        months: [0,1,2,3,4,6,9,12],
        att: [1.31,1.67,1.72,1.51,1.80,1.54,0.97,-0.25],
        ciLo: [-0.33,0.02,0.12,-0.08,0.25,0.02,-0.44,-1.66],
        ciHi: [2.96,3.31,3.32,3.10,3.34,3.06,2.37,1.16]
      },
      'OR': {
        label: 'Oregon', effectiveDate: 'Jan 1, 2022',
        months: [0,1,2,3,4,6,9,12],
        att: [2.80,2.91,3.08,3.37,3.40,4.56,3.68,3.73],
        ciLo: [1.20,1.29,1.48,1.77,1.84,3.03,2.22,2.28],
        ciHi: [4.41,4.53,4.68,4.96,4.96,6.09,5.13,5.17]
      },
      'UT': {
        label: 'Utah', effectiveDate: 'May 4, 2022',
        months: [0,1,2,3,4,6,9,12],
        att: [0.07,-0.50,-0.51,-0.67,-0.75,-1.62,-0.61,-0.63],
        ciLo: [-1.44,-2.02,-2.04,-2.19,-2.26,-3.07,-2.06,-2.02],
        ciHi: [1.58,1.03,1.02,0.85,0.76,-0.16,0.84,0.76]
      },
      'DE': {
        label: 'Delaware', effectiveDate: 'Oct 10, 2022',
        months: [0,1,2,3,4,6,9,12],
        att: [3.09,2.03,0.95,0.78,0.53,1.25,4.52,2.32],
        ciLo: [1.48,0.42,-0.66,-0.84,-1.07,-0.31,3.05,1.03],
        ciHi: [4.70,3.64,2.56,2.39,2.12,2.80,5.99,3.61]
      },
      'IN': {
        label: 'Indiana', effectiveDate: 'Jul 1, 2023',
        months: [0,1,2,3,4,6,9,12],
        att: [1.64,1.65,1.16,1.22,0.82,-0.37,-0.10,-0.33],
        ciLo: [0.24,0.30,-0.12,-0.04,-0.42,-1.66,-1.32,-1.56],
        ciHi: [3.03,3.00,2.44,2.47,2.05,0.92,1.11,0.90]
      },
      'CO': {
        label: 'Colorado', effectiveDate: 'Aug 7, 2023',
        months: [0,1,2,3,4,6,9,12],
        att: [0.07,0.11,0.18,0.06,0.47,0.58,-0.86,-1.45],
        ciLo: [-1.29,-1.20,-1.11,-1.21,-0.82,-0.75,-2.04,-2.74],
        ciHi: [1.42,1.42,1.46,1.34,1.76,1.92,0.32,-0.17]
      },
      'NV': {
        label: 'Nevada', effectiveDate: 'Jul 1, 2024',
        months: [0,1,2,3,4],
        att: [1.91,1.60,-1.36,-1.25,-3.87],
        ciLo: [0.63,0.28,-2.47,-2.38,-4.60],
        ciHi: [3.18,2.93,-0.25,-0.12,-3.13]
      }
    },
    'exc_rate': {
      'IL': {
        label: 'Illinois', effectiveDate: 'Jan 1, 2022',
        months: [0,1,2,3,4,6,9,12],
        att: [-0.08,-0.06,0.05,0.22,0.30,0.30,0.06,0.12],
        ciLo: [-0.76,-0.71,-0.61,-0.39,-0.32,-0.35,-0.51,-0.43],
        ciHi: [0.59,0.59,0.71,0.83,0.92,0.94,0.62,0.66]
      },
      'OR': {
        label: 'Oregon', effectiveDate: 'Jan 1, 2022',
        months: [0,1,2,3,4,6,9,12],
        att: [1.63,1.42,1.54,2.04,2.00,1.90,1.51,1.58],
        ciLo: [0.99,0.78,0.90,1.44,1.39,1.26,0.92,1.00],
        ciHi: [2.28,2.06,2.19,2.65,2.62,2.54,2.11,2.16]
      },
      'UT': {
        label: 'Utah', effectiveDate: 'May 4, 2022',
        months: [0,1,2,3,4,6,9,12],
        att: [0.23,0.17,0.00,-0.46,-0.42,-0.36,-0.77,-0.29],
        ciLo: [-0.41,-0.48,-0.66,-1.09,-1.02,-0.96,-1.36,-0.87],
        ciHi: [0.86,0.83,0.66,0.17,0.19,0.24,-0.18,0.30]
      },
      'DE': {
        label: 'Delaware', effectiveDate: 'Oct 10, 2022',
        months: [0,1,2,3,4,6,9,12],
        att: [-3.32,-2.94,-2.63,-2.83,-2.44,-3.69,-4.73,-3.81],
        ciLo: [-4.02,-3.64,-3.32,-3.50,-3.11,-4.35,-5.36,-4.41],
        ciHi: [-2.62,-2.25,-1.95,-2.15,-1.77,-3.02,-4.11,-3.21]
      },
      'IN': {
        label: 'Indiana', effectiveDate: 'Jul 1, 2023',
        months: [0,1,2,3,4,6,9,12],
        att: [-1.15,-1.12,-1.34,-1.55,-1.64,-1.67,-1.35,-1.43],
        ciLo: [-1.72,-1.69,-1.89,-2.08,-2.16,-2.16,-1.84,-1.93],
        ciHi: [-0.57,-0.55,-0.79,-1.02,-1.11,-1.18,-0.86,-0.94]
      },
      'CO': {
        label: 'Colorado', effectiveDate: 'Aug 7, 2023',
        months: [0,1,2,3,4,6,9,12],
        att: [-2.13,-2.36,-2.58,-2.47,-2.12,-2.54,-2.05,-1.77],
        ciLo: [-2.73,-2.95,-3.15,-3.04,-2.69,-3.05,-2.62,-2.43],
        ciHi: [-1.52,-1.77,-2.01,-1.90,-1.55,-2.03,-1.48,-1.12]
      },
      'NV': {
        label: 'Nevada', effectiveDate: 'Jul 1, 2024',
        months: [0,1,2,3,4],
        att: [0.55,0.60,0.56,0.70,1.14],
        ciLo: [0.12,0.16,0.16,0.28,0.77],
        ciHi: [0.98,1.04,0.96,1.12,1.51]
      }
    },
    'clear_rate': {
      'IL': {
        label: 'Illinois', effectiveDate: 'Jan 1, 2022',
        months: [0,1,2,3,4,6,9,12],
        att: [1.23,1.61,1.77,1.73,2.09,1.84,1.02,-0.13],
        ciLo: [-0.61,-0.25,-0.01,-0.01,0.41,0.19,-0.43,-1.56],
        ciHi: [3.07,3.46,3.56,3.47,3.78,3.48,2.48,1.29]
      },
      'OR': {
        label: 'Oregon', effectiveDate: 'Jan 1, 2022',
        months: [0,1,2,3,4,6,9,12],
        att: [4.43,4.33,4.62,5.41,5.40,6.46,5.19,5.30],
        ciLo: [2.67,2.52,2.85,3.68,3.71,4.82,3.68,3.85],
        ciHi: [6.20,6.13,6.39,7.15,7.09,8.10,6.69,6.76]
      },
      'UT': {
        label: 'Utah', effectiveDate: 'May 4, 2022',
        months: [0,1,2,3,4,6,9,12],
        att: [0.30,-0.33,-0.51,-1.13,-1.17,-1.98,-1.38,-0.92],
        ciLo: [-1.35,-2.00,-2.16,-2.75,-2.76,-3.47,-2.84,-2.35],
        ciHi: [1.94,1.35,1.14,0.50,0.43,-0.48,0.09,0.52]
      },
      'DE': {
        label: 'Delaware', effectiveDate: 'Oct 10, 2022',
        months: [0,1,2,3,4,6,9,12],
        att: [-0.23,-0.91,-1.68,-2.05,-1.92,-2.44,-0.21,-1.50],
        ciLo: [-1.81,-2.48,-3.24,-3.60,-3.45,-3.94,-1.64,-2.72],
        ciHi: [1.36,0.66,-0.13,-0.50,-0.38,-0.94,1.22,-0.27]
      },
      'IN': {
        label: 'Indiana', effectiveDate: 'Jul 1, 2023',
        months: [0,1,2,3,4,6,9,12],
        att: [0.49,0.53,-0.18,-0.33,-0.82,-2.04,-1.45,-1.76],
        ciLo: [-0.93,-0.84,-1.48,-1.58,-2.04,-3.31,-2.67,-3.03],
        ciHi: [1.91,1.90,1.12,0.91,0.40,-0.78,-0.23,-0.50]
      },
      'CO': {
        label: 'Colorado', effectiveDate: 'Aug 7, 2023',
        months: [0,1,2,3,4,6,9,12],
        att: [-2.06,-2.25,-2.40,-2.41,-1.65,-1.96,-2.91,-3.23],
        ciLo: [-3.44,-3.59,-3.69,-3.68,-2.94,-3.28,-4.13,-4.53],
        ciHi: [-0.68,-0.90,-1.12,-1.14,-0.37,-0.63,-1.69,-1.92]
      },
      'NV': {
        label: 'Nevada', effectiveDate: 'Jul 1, 2024',
        months: [0,1,2,3,4],
        att: [2.46,2.20,-0.80,-0.55,-2.73],
        ciLo: [1.19,0.88,-1.89,-1.58,-3.43],
        ciHi: [3.73,3.52,0.28,0.48,-2.02]
      }
    }
  };

  var currentTimeState = 'IL';
  var currentTimeOutcome = 'arrest_rate';

  function renderTimeSeries(stateCode, outcome) {
    currentTimeState = stateCode;
    currentTimeOutcome = outcome;
    var label = outcomeLabels[outcome];
    var d = timeData[outcome][stateCode];

    // Show/hide NV warning
    document.getElementById('nv-warning').style.display = stateCode === 'NV' ? 'block' : 'none';

    // Update selector buttons
    document.querySelectorAll('#time-state-selector .state-btn').forEach(function(b) {
      b.classList.toggle('active', b.getAttribute('data-state') === stateCode);
    });

    var xLabels = d.months.map(function(m) { return 'Month ' + m; });

    var timeH = chartHeight(450, 360, 320);
    document.getElementById('time-chart').style.height = timeH + 'px';

    var traceLine = {
      x: xLabels,
      y: d.att,
      type: 'scatter',
      mode: 'lines+markers',
      name: 'ATT',
      line: { color: '#3b82f6', width: isMobile() ? 2 : 2.5 },
      marker: { size: isMobile() ? 5 : 7, color: '#3b82f6' },
      hovertemplate: '<b>' + d.label + '</b><br>%{x}<br>ATT: %{y:.2f} pp<extra></extra>'
    };

    var traceBand = {
      x: xLabels.concat(xLabels.slice().reverse()),
      y: d.ciHi.concat(d.ciLo.slice().reverse()),
      type: 'scatter',
      fill: 'toself',
      fillcolor: 'rgba(59,130,246,0.15)',
      line: { color: 'transparent' },
      showlegend: false,
      hoverinfo: 'skip'
    };

    var mobile = isMobile();
    var layout = {
      height: timeH,
      title: {
        text: d.label + ' \u2014 ' + label + ' Effect Over Time',
        font: { size: mobile ? 12 : 15, family: fontFamily, color: '#1e293b' },
        x: 0.02, xanchor: 'left'
      },
      annotations: [{
        x: 1, y: 1.08, xref: 'paper', yref: 'paper',
        text: 'Ban effective: ' + d.effectiveDate,
        showarrow: false,
        font: { size: mobile ? 9 : 11, color: '#64748b', family: fontFamily },
        xanchor: 'right'
      }],
      margin: mobile ? { t: 50, b: 40, l: 42, r: 10 } : { t: 60, b: 50, l: 60, r: 30 },
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)',
      font: { family: fontFamily },
      xaxis: {
        tickfont: { size: mobile ? 9 : 11 },
        gridcolor: '#f1f5f9',
        tickangle: mobile ? -45 : 0
      },
      yaxis: {
        title: { text: 'Change in ' + label + ' (pp)', font: { size: mobile ? 10 : 12 } },
        tickfont: { size: mobile ? 9 : 11 },
        zeroline: true,
        zerolinecolor: '#475569',
        zerolinewidth: 1.5,
        gridcolor: '#e2e8f0'
      },
      shapes: [{
        type: 'line',
        x0: -0.5,
        x1: xLabels.length - 0.5,
        y0: 0, y1: 0,
        line: { color: '#475569', width: 1.5, dash: 'dash' }
      }],
      showlegend: false
    };

    Plotly.newPlot('time-chart', [traceBand, traceLine], layout, getPlotlyConfig());
  }

  // ---- Time series state selector handler ----
  document.querySelectorAll('#time-state-selector .state-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      renderTimeSeries(this.getAttribute('data-state'), currentTimeOutcome);
    });
  });

  // ---- Time series outcome toggle handler ----
  document.querySelectorAll('#time-outcome-toggle .outcome-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('#time-outcome-toggle .outcome-btn').forEach(function(b) { b.classList.remove('active'); });
      this.classList.add('active');
      currentTimeOutcome = this.getAttribute('data-outcome');
      renderTimeSeries(currentTimeState, currentTimeOutcome);
    });
  });

  // ---- Initial renders ----
  renderMap('clear_rate');
  renderLawTable('clear_rate');

  // Deferred renders for hidden tabs
  var rendered = { overview: true };

  function ensureRendered(tabId) {
    if (rendered[tabId]) return;
    rendered[tabId] = true;
    if (tabId === 'state-results') {
      renderHeatmap();
      renderBarChart('arrest_rate');
    } else if (tabId === 'time-effects') {
      renderTimeSeries('IL', 'arrest_rate');
    }
  }

  tabBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      var tabId = this.getAttribute('data-tab');
      ensureRendered(tabId);
    });
  });

})();
</script>

</body>
</html>
